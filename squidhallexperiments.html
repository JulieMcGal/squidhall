<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<!-- 
		This is a Squid Hall experimental page. It allows you 
		to add experimental code after prepare and and after build 
		processing. Copy this page to use for your own experiments. 
	-->
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>
			Squid Hall Test
		</title>
		<style>
		    html, body {
		        overflow: hidden;
		        width: 100%;
		        height: 100%;
		        margin: 0;
		        padding: 0;
		    }

		    #renderCanvas {
		        width: 100%;
		        height: 100%;
		        touch-action: none;
		    }

			#fpsLabel {
			    position: absolute;
			    right: 20px;
			    top: 20px;
			    color: #8AA;
				background:#606;
			    cursor: default;
			}

			/* Modal Popup box style */
			.mpopup {
			    display: none;
			    position: fixed;
			    z-index: 1;
			    padding-top: 100px;
			    left: 0;
			    top: 0;
			    width: 100%;
			    height: 100%;
			    overflow: auto;
			    background-color: rgb(0,0,0);
			    background-color: rgba(0,0,0,0.4);
			}
			.mpopup-content {
			    position: relative;
			    background-color: #fefefe;
			    margin: auto;
			    padding: 0;
			    width: 60%;
			    box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
			    -webkit-animation-name: animatetop;
			    -webkit-animation-duration: 0.4s;
			    animation-name: animatetop;
			    animation-duration: 0.4s
			}
			.mpopup-head {
			    padding: 2px 8px;
			    background-color: #337000;
			    color: white;
			}
			.mpopup-close {
				cursor: pointer;
				font-size: x-large;
				//color: gold;
				padding: 0;
				//padding: 1px;
				margin: 0;
				//border: solid 2px black;
			}
			//.mpopup-close:hover {color: antiquewhite}
			#mpopup-title {
				text-align: center;
				margin: 0;
			}
			.mpopup-main {padding: 2px 16px;}
			.mpopup-foot {
			    padding: 2px 16px;
			    background-color: #337000;
			    color: white;
			}
			.mpopup-foot a:link {color: gold;}
			.mpopup-foot a:visited {color: lightblue;}
			.mpopup-foot a:hover {color: antiquewhite}
			.mpopup-foot a:active {color: antiquewhite}

			/* add animation effects */
			@-webkit-keyframes animatetop {
			    from {top:-300px; opacity:0}
			    to {top:0; opacity:1}
			}

			@keyframes animatetop {
			    from {top:-300px; opacity:0}
			    to {top:0; opacity:1}
			}
		</style>
		<!-- SCRIPTS START -->

		<!-- Babylon.js support libraries START -->

		<!-- Local copies so we control features.-->
		<script src="libs/babylonjs/babylon.js"></script>
		<script src="libs/babylonjs/babylonjs.proceduralTextures.min.js"></script>
		<script src="libs/babylonjs/babylonjs.materials.min.js"></script>
		<script src="libs/babylonjs/loaders/babylonjs.loaders.min.js"></script>


		<!-- CDN for production and final testing.
		<script src="https://cdn.babylonjs.com/babylon.js"></script>
		<script src="https://cdn.babylonjs.com/babylonjs.proceduralTextures.min.js"></script>
		<script src="https://cdn.babylonjs.com/babylonjs.materials.min.js"></script>
		<script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
		-->


		<!-- Babylon.js support libraries END -->

		<!-- Other libraries START -->
		<!-- Other libraries END -->

		<!-- Squidspace START -->
		<script src="libs/squidspace.js"></script>
		<!-- Squidspace END -->

		<!-- World START -->
		<script src="libs/squidhall.js"></script>
		<script src="libs/modules/world.js"></script>
		<script src="libs/modules/furniture.js"></script>
		<!-- World END -->

		<!-- SCRIPTS END -->
	</head>
	<body>

		<div id="mpopupBox" class="mpopup">
		    <div class="mpopup-content">
		        <div class="mpopup-head">
		            <span class="mpopup-close">&#x274E;</span>
		            <h2 id="mpopup-title">Simple Modal Popup</h2>
		        </div>
		        <div class="mpopup-main" id="mpopup-text">
		            <p>This is a simple modal popup using JavaScript and CSS</p>
		            <p>Foo and Bar!</p>
		        </div>
		        <div class="mpopup-foot" id="mpopup-link">
		        </div>
		    </div>
		</div>

		<div id="fpsLabel"></div>

		<!-- touch-action="none" for best results from PEP -->
		<canvas id="renderCanvas" touch-action="none"></canvas>

<script>
//<![CDATA[

	//
	// Web Page Stuff.
	//

	var mpopup = document.getElementById('mpopupBox');
	var close = document.getElementsByClassName("mpopup-close")[0];

	showMessagePopup = function(data) {
		let mainText = data[`<p>${data["text"]}</p>`];
		let linkText = undefined;

		if ("title" in data) {
			document.getElementById('mpopup-title').innerHTML = data["title"];
		}
		else {
			document.getElementById('mpopup-title').innerHTML = "Attention!";
		}

		if ("text" in data) {
			document.getElementById('mpopup-text').innerHTML = `<p>${data["text"]}</p>`;
		}
		else {
			document.getElementById('mpopup-text').innerHTML = "<p>Normally a message would be here.</p>";
		}

		if ("link" in data && "link-text" in data) {
			document.getElementById('mpopup-link').innerHTML = `<p>See more here: <a href='${data["link"]}' target='_blank'>${data["link-text"]}</a></p>`;
		}

		mpopup.style.display = "block";
	}

	close.onclick = function() {
	    mpopup.style.display = "none";
	}

	window.onclick = function(event) {
	    if (event.target == mpopup) {
	        mpopup.style.display = "none";
	    }
	}

	showMessagePopup(
		{
			"title": "Welcome to Squid Hall - A VR re-creation of the TSB Arena",
		 	"text": "Your mouse controls the direction you are facing. The arrow keys or the W, A, S, and D keys control movement forward/back, and left/right. You can click on some of the objects to learn more about them.<br/><br/>Click the close button or outside this message box to start."
		}
	);


	//
	// Everything below is 3D Stuff.
	//
	
	
	//
	// Experiments here.
	//
	
	// Anything inside this function is executed after SquidSpace.prepareWorld().
	var experimentAfterWorldPrep = function(scene) {
		
	}
	
	// Anything inside this function is executed after SquidSpace.buildWorld().
	var experimentAfterWorldBuild = function(scene) {
		// NOTE: Comment this out to run the experiment.
		return;
			
		/*
		// Decal placement on objects.
		// See https://www.babylonjs-playground.com/#1BAPRM#73
		// See https://doc.babylonjs.com/how_to/decals
		let scalingFactor = 0.0015;
		let decalData = [
			{
				texture: "/textures/broadmore1.jpg",
				position: [1.95, 0.05],
				// Image is 680x386, working it this way gets us a decent scale.
				size: [680 * scalingFactor, 386 * scalingFactor] 
			},
			{
				texture: "/textures/broadmorebio.png",
				position: [1.75, 0.75],
				// We are scaling this one to 3/4  size.
				size: [722 * scalingFactor * 0.75, 925 * scalingFactor * 0.75]
			},
			{
				texture: "/textures/broadmore2.jpg",
				position: [1.2, 0.05],
				size: [680 * scalingFactor, 880 * scalingFactor]
			},
			{
				texture: "/textures/broadmore3.jpg",
				position: [0.75, 0.65],
				size: [680 * scalingFactor, 1043 * scalingFactor]
			},
			{
				texture: "/textures/broadmore4.jpg",
				position: [0.7, 0.05],
				size: [680 * scalingFactor, 494 * scalingFactor]
			},
		]
		let panel = SquidSpace.getLoadedObjectMeshes("lonelypanelexample");
		//let dd = decalData[0]; // do only one
		for (dd of decalData) { // do all in loop
			let decalMaterial = new BABYLON.StandardMaterial("broadmoremat", scene);
			let decalTexture = new BABYLON.Texture(dd.texture, scene);
			
			decalTexture.vScale = -1;
			
			// Texture size returns 0, 0 for a loaded texture. Not helpful.
			//let tsize = decalTexture.getSize();
			//console.log(`Texture size - w: ${tsize.width} h: ${tsize.width}`);
			
			// Self lighting. Also puts decal on both sides of panel.
			//decalMaterial.emissiveTexture = decalTexture; 
			
			// Needs lighting, but works.
			decalMaterial.diffuseTexture = decalTexture; 
			
			// Don't use.
			//decalMaterial.diffuseTexture.hasAlpha = true; 
			
			// Doesn't seem to help.
			//decalMaterial.alpha = 0.9; 
			
			// No difference I can see. 
			decalMaterial.backFaceCulling = false; 
			
			// This is required to make it look good.
			decalMaterial.zOffset = -2;
			
			// x affects decal width, y doesn't matter but can't be 0, z affects height.
			let decalSize = new BABYLON.Vector3(dd.size[0], 1, dd.size[1]); 
			
			let decal = BABYLON.MeshBuilder.CreateDecal("decal", panel[0], 
					{
						position: panel[0].position,
						//position: new BABYLON.Vector3(dd["position"][0], dd["position"][1], dd["position"][2]),
						//size: new BABYLON.Vector3(dd["size"][0], dd["size"][1], dd["size"][2])
						size: decalSize
					}, 
					scene
			);
			decal.material = decalMaterial;
			
			// NOTE: Whether to use x or z to position horizontally and whether to 
			//       add or subtract might depend on the panel rotation.
			//decal.position.x += 1; // This moves it away.
			decal.position.y += dd.position[0]; // Move it up.
			decal.position.z += dd.position[1]; // Move it over.
		}
	
		// Add an event to the panel.
		SquidSpace.attachClickEventToObject("lonelypanelexample", "onClickShowPopup",
			{
				"title": "Greg Broadmore â€“ Artist Guest of Honour",
			 	"text": "Greg Broadmore, aka 'The King of Fatboss', is the ConZealand Artist Guest of Honour.",
				"link-text": "Greg Broadmore",
				"link": "https://conzealand.nz/greg-broadmore-guest"
			}, scene
		);   	
		//*/

		/* I want to add this for debugVerbose mode, but it isn't working and I don't have time to figure it out.
		var showWorldAxis = function showWorldAxis(size, scene) {
		    var makeTextPlane = function(text, color, size) {
		        var dynamicTexture = new BABYLON.DynamicTexture("DynamicTexture", 50, scene, true);
		        dynamicTexture.hasAlpha = true;
		        dynamicTexture.drawText(text, 5, 40, "bold 36px Arial", color , "transparent", true);
		        var plane = BABYLON.Mesh.CreatePlane("TextPlane", size, scene, true);
		        plane.material = new BABYLON.StandardMaterial("TextPlaneMaterial", scene);
		        plane.material.backFaceCulling = false;
		        plane.material.specularColor = new BABYLON.Color3(0, 0, 0);
		        plane.material.diffuseTexture = dynamicTexture;
		    return plane;
		     };
		    var axisX = BABYLON.Mesh.CreateLines("axisX", [
		      BABYLON.Vector3.Zero(), new BABYLON.Vector3(size, 0, 0), new BABYLON.Vector3(size * 0.95, 0.05 * size, 0),
		      new BABYLON.Vector3(size, 0, 0), new BABYLON.Vector3(size * 0.95, -0.05 * size, 0)
		      ], scene);
		    axisX.color = new BABYLON.Color3(1, 0, 0);
		    var xChar = makeTextPlane("X", "red", size / 10);
		    xChar.position = new BABYLON.Vector3(0.9 * size, -0.05 * size, 0);
		    var axisY = BABYLON.Mesh.CreateLines("axisY", [
		        BABYLON.Vector3.Zero(), new BABYLON.Vector3(0, size, 0), new BABYLON.Vector3( -0.05 * size, size * 0.95, 0),
		        new BABYLON.Vector3(0, size, 0), new BABYLON.Vector3( 0.05 * size, size * 0.95, 0)
		        ], scene);
		    axisY.color = new BABYLON.Color3(0, 1, 0);
		    var yChar = makeTextPlane("Y", "green", size / 10);
		    yChar.position = new BABYLON.Vector3(0, 0.9 * size, -0.05 * size);
		    var axisZ = BABYLON.Mesh.CreateLines("axisZ", [
		        BABYLON.Vector3.Zero(), new BABYLON.Vector3(0, 0, size), new BABYLON.Vector3( 0 , -0.05 * size, size * 0.95),
		        new BABYLON.Vector3(0, 0, size), new BABYLON.Vector3( 0, 0.05 * size, size * 0.95)
		        ], scene);
		    axisZ.color = new BABYLON.Color3(0, 0, 1);
		    var zChar = makeTextPlane("Z", "blue", size / 10);
		    zChar.position = new BABYLON.Vector3(0, 0.05 * size, 0.9 * size);
		};
		*/
	}
	
	//
	// START BASIC SQUID HALL TEST CODE
	//
	// NOTE: Cut and paste this code into your HTML file for a virtual Squid Hall 
	//       with extra test and debug functionality.
	//

	// Set up Babylon.js.
	var canvas = document.getElementById("renderCanvas"); // Get the canvas element
	var engine = new BABYLON.Engine(canvas, true); // Generate the BABYLON 3D engine
	var scene = new BABYLON.Scene(engine);
	
	// Wire in the SquidSpace common code.
	SquidCommon.wireSquidSpace(null, null, SquidSpace);
	
	// Wire in the SquidSpace debug code.
	SquidDebug.wireSquidSpace(null, null, SquidSpace);
	
	// Wire in the SquidHall code.
	SquidHall.wireSquidSpace(null, null, SquidSpace);
	
	// Set log level.
	SquidSpace.setLogLevel(SS_LOG_ALL);

	// Here's where we do the magic.
	document.addEventListener("DOMContentLoaded", (event) =>{
		experimentAfterWorldPrep(scene);
		
		// Create and activate the world space.
		if (SquidSpace.buildWorld(world, [furniture], scene)) {
			// Register a render loop to repeatedly render the world space.
			// NOTE: Use commented out render loop below if you don't want FPS label.
			let currFPS = 0;
			let newFPS = 0;
		    var fpsLabel = document.getElementById("fpsLabel");
			
			experimentAfterWorldBuild(scene);
			
			// Add page-specific event handlers. (The events themselves are added when 
			// SquidSpace.buildWorld() is called.)
			SquidSpace.addEventListener("onClickShowPopup", function(sourceObjectName, data){
				showMessagePopup(data);
			});
			
			engine.runRenderLoop(function() {
				scene.render();

				// Update FPS on screen if it has changed.
				newFPS = engine.getFps().toFixed();
				if (currFPS != newFPS) {
					currFPS = newFPS;
				    fpsLabel.innerHTML = `&nbsp;${currFPS} fps&nbsp;`;
				}
			});

			// Alternate render loop without FPS label.
			//engine.runRenderLoop(function() {
			//	scene.render();
			//});

			// Watch for browser/canvas resize events
			window.addEventListener("resize", function() {
				engine.resize();
			});
		}
		else {
			console.log("Failed to load squid space.")

			showMessagePopup(
				{
					"title": "Squid Hall 3D Space Failed to Load",
				 	"text": "We apologize! Something happened while loading the 3D simulation space. It's possible your computer or web browser do not support WebGL or other features required to make it work. Please try again with a different browser or computer."
				}
			);
		}
	});

	//
	// END BASIC SQUID HALL CODE
	//

//]]>
</script>
	</body>
</html>