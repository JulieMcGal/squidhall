<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<!-- 
		
		This is Squid Hall!
		
		Squid Hall was created for ConZealand as a virtual replacement for the 
		Wellington TSB Arena after the 2020 coronavirus pandemic led to the 
		cancellation of large events worldwide. Conzealand didn't cancel outright, 
		instead it moved online in every way it could possibly do so, from video
		meetings to text chat to web pages to even Virtual Reality.
		
		This is just one of those projects. We hope you enjoy it. 
		
		=== CREDITS ===
		
		Chief Propeller Head: Tom Becker
		
		Cyberspace Architect: Jack William Bell
		
		3D Team:
		
			* Taiyo Fujii
		
			* Ryan Casal
		
			* Dan Campbell 
	-->
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>
			Squid Hall Test
		</title>
		<style>
		    html, body {
		        overflow: hidden;
		        width: 100%;
		        height: 100%;
		        margin: 0;
		        padding: 0;
		    }

		    #renderCanvas {
		        width: 100%;
		        height: 100%;
		        touch-action: none;
		    }

			#fpsLabel {
			    position: absolute;
			    right: 20px;
			    top: 20px;
			    color: #8AA;
				background:#606;
			    cursor: default;
			}

			/* Modal Popup box style */
			.mpopup {
			    display: none;
			    position: fixed;
			    z-index: 1;
			    padding-top: 100px;
			    left: 0;
			    top: 0;
			    width: 100%;
			    height: 100%;
			    overflow: auto;
			    background-color: rgb(0,0,0);
			    background-color: rgba(0,0,0,0.4);
			}
			.mpopup-content {
			    position: relative;
			    background-color: #fefefe;
			    margin: auto;
			    padding: 0;
			    width: 60%;
			    box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
			    -webkit-animation-name: animatetop;
			    -webkit-animation-duration: 0.4s;
			    animation-name: animatetop;
			    animation-duration: 0.4s
			}
			.mpopup-head {
			    padding: 2px 8px;
			    background-color: #337000;
			    color: white;
			}
			.mpopup-close {
				cursor: pointer;
				font-size: x-large;
				//color: gold;
				padding: 0;
				//padding: 1px;
				margin: 0;
				//border: solid 2px black;
			}
			//.mpopup-close:hover {color: antiquewhite}
			#mpopup-title {
				text-align: center;
				margin: 0;
			}
			.mpopup-main {padding: 2px 16px;}
			.mpopup-foot {
			    padding: 2px 16px;
			    background-color: #337000;
			    color: white;
			}
			.mpopup-foot a:link {color: gold;}
			.mpopup-foot a:visited {color: lightblue;}
			.mpopup-foot a:hover {color: antiquewhite}
			.mpopup-foot a:active {color: antiquewhite}

			/* add animation effects */
			@-webkit-keyframes animatetop {
			    from {top:-300px; opacity:0}
			    to {top:0; opacity:1}
			}

			@keyframes animatetop {
			    from {top:-300px; opacity:0}
			    to {top:0; opacity:1}
			}
		</style>
		<!-- SCRIPTS START -->

		<!-- Babylon.js support libraries START -->

		<!-- Local copies so we control features.-->
		<script src="libs/babylonjs/babylon.js"></script>
		<script src="libs/babylonjs/babylonjs.proceduralTextures.min.js"></script>
		<script src="libs/babylonjs/babylonjs.materials.min.js"></script>
		<script src="libs/babylonjs/loaders/babylonjs.loaders.min.js"></script>


		<!-- CDN for production and final testing.
		<script src="https://cdn.babylonjs.com/babylon.js"></script>
		<script src="https://cdn.babylonjs.com/babylonjs.proceduralTextures.min.js"></script>
		<script src="https://cdn.babylonjs.com/babylonjs.materials.min.js"></script>
		<script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
		-->


		<!-- Babylon.js support libraries END -->

		<!-- Other libraries START -->
		<!-- Other libraries END -->

		<!-- Squidspace START -->
		<script src="libs/squidspace.js"></script>
		<!-- Squidspace END -->

		<!-- World START -->
		<script src="libs/objects/world.js"></script>
		<script src="libs/objects/furniture.js"></script>
		<!-- World END -->

		<!-- SCRIPTS END -->
	</head>
	<body>

		<div id="mpopupBox" class="mpopup">
		    <div class="mpopup-content">
		        <div class="mpopup-head">
		            <span class="mpopup-close">&#x274E;</span>
		            <h2 id="mpopup-title">Simple Modal Popup</h2>
		        </div>
		        <div class="mpopup-main" id="mpopup-text">
		            <p>This is a simple modal popup using JavaScript and CSS</p>
		            <p>Foo and Bar!</p>
		        </div>
		        <div class="mpopup-foot" id="mpopup-link">
		        </div>
		    </div>
		</div>

		<div id="fpsLabel"></div>

		<!-- touch-action="none" for best results from PEP -->
		<canvas id="renderCanvas" touch-action="none"></canvas>

<script>
//<![CDATA[

	//
	// Web Page Stuff.
	//

	var mpopup = document.getElementById('mpopupBox');
	var close = document.getElementsByClassName("mpopup-close")[0];

	showMessagePopup = function(data) {
		let mainText = data[`<p>${data["text"]}</p>`];
		let linkText = undefined;

		if ("title" in data) {
			document.getElementById('mpopup-title').innerHTML = data["title"];
		}
		else {
			document.getElementById('mpopup-title').innerHTML = "Attention!";
		}

		if ("text" in data) {
			document.getElementById('mpopup-text').innerHTML = `<p>${data["text"]}</p>`;
		}
		else {
			document.getElementById('mpopup-text').innerHTML = "<p>Normally a message would be here.</p>";
		}

		if ("link" in data && "link-text" in data) {
			document.getElementById('mpopup-link').innerHTML = `<p>See more here: <a href='${data["link"]}' target='_blank'>${data["link-text"]}</a></p>`;
		}

		mpopup.style.display = "block";
	}

	close.onclick = function() {
	    mpopup.style.display = "none";
	}

	window.onclick = function(event) {
	    if (event.target == mpopup) {
	        mpopup.style.display = "none";
	    }
	}

	showMessagePopup(
		{
			"title": "Welcome to Squid Hall - A VR re-creation of the TSB Arena",
		 	"text": "Your mouse controls the direction you are facing. The arrow keys or the W, A, S, and D keys control movement forward/back, and left/right. You can click on some of the objects to learn more about them.<br/><br/>Click the close button or outside this message box to start."
		}
	);


	//
	// Everything below is 3D Stuff.
	//
	
	
	//
	// Experiments here.
	//
	
	// Anything inside this function is executed after SquidSpace.prepareWorld().
	var experimentAfterWorldPrep = function(scene) {
		
	}
	
	// Anything inside this function is executed after SquidSpace.buildWorld().
	var experimentAfterWorldBuild = function(scene) {
		// NOTE: Comment this out to run the experiment.
		//return;
		
		//*
		// Place object on object.
		// See https://www.babylonjs-playground.com/#0UJYJQ#6
		let height = 0;
		let teapot = SquidSpace.cloneObject("teapot", "displayteapot");
		let plinth = SquidSpace.getLoadedObjectMeshes("plinth11");
		// Find max height for plinth.
		for (pmesh of plinth) {
			let bi = pmesh.getBoundingInfo().boundingBox.vectorsWorld;
			let meshHeight = Number(bi[1].y-(bi[0].y));
			if (height < meshHeight) height = meshHeight;
		}
		console.log(`Plinth height is ${height}.`)
		
		for (tmesh of teapot) {
			// First scale it (won't be needed after we properly scale the model).
			tmesh.scaling = new BABYLON.Vector3(0.2,0.2,0.2);
			
			// Now position it.
	   	 	tmesh.position.copyFrom(plinth[0].position);
	        tmesh.position.y = height;
			tmesh.checkCollisions = false;
			tmesh.isVisible = true;
		}
		
		// Add an event to the teapot.
		SquidSpace.attachClickEventToObject("displayteapot", "onClickShowPopup",
			{
				"title": "Utah Teapot",
			 	"text": "The Utah teapot, or the Newell teapot, is a 3D test model that has become a standard reference object and an in-joke within the computer graphics community.",
				"link-text": "Utah Teapot on Wikipedia",
				"link": "https://en.wikipedia.org/wiki/Utah_teapot"
			}, scene
		);   	
		//*/
		
			
		/*
		// Decal placement on objects.
		// See https://www.babylonjs-playground.com/#1BAPRM#73
		// See https://doc.babylonjs.com/how_to/decals
		let scalingFactor = 0.0015;
		let decalData = [
			{
				texture: "/textures/broadmore1.jpg",
				position: [1.95, 0.05],
				// Image is 680x386, working it this way gets us a decent scale.
				size: [680 * scalingFactor, 386 * scalingFactor] 
			},
			{
				texture: "/textures/broadmorebio.png",
				position: [1.75, 0.75],
				// We are scaling this one to 3/4  size.
				size: [722 * scalingFactor * 0.75, 925 * scalingFactor * 0.75]
			},
			{
				texture: "/textures/broadmore2.jpg",
				position: [1.2, 0.05],
				size: [680 * scalingFactor, 880 * scalingFactor]
			},
			{
				texture: "/textures/broadmore3.jpg",
				position: [0.75, 0.65],
				size: [680 * scalingFactor, 1043 * scalingFactor]
			},
			{
				texture: "/textures/broadmore4.jpg",
				position: [0.7, 0.05],
				size: [680 * scalingFactor, 494 * scalingFactor]
			},
		]
		let panel = SquidSpace.getLoadedObjectMeshes("lonelypanelexample");
		//let dd = decalData[0]; // do only one
		for (dd of decalData) { // do all in loop
			let decalMaterial = new BABYLON.StandardMaterial("broadmoremat", scene);
			let decalTexture = new BABYLON.Texture(dd.texture, scene);
			
			decalTexture.vScale = -1;
			
			// Texture size returns 0, 0 for a loaded texture. Not helpful.
			//let tsize = decalTexture.getSize();
			//console.log(`Texture size - w: ${tsize.width} h: ${tsize.width}`);
			
			// Self lighting. Also puts decal on both sides of panel.
			//decalMaterial.emissiveTexture = decalTexture; 
			
			// Needs lighting, but works.
			decalMaterial.diffuseTexture = decalTexture; 
			
			// Don't use.
			//decalMaterial.diffuseTexture.hasAlpha = true; 
			
			// Doesn't seem to help.
			//decalMaterial.alpha = 0.9; 
			
			// No difference I can see. 
			decalMaterial.backFaceCulling = false; 
			
			// This is required to make it look good.
			decalMaterial.zOffset = -2;
			
			// x affects decal width, y doesn't matter but can't be 0, z affects height.
			let decalSize = new BABYLON.Vector3(dd.size[0], 1, dd.size[1]); 
			
			let decal = BABYLON.MeshBuilder.CreateDecal("decal", panel[0], 
					{
						position: panel[0].position,
						//position: new BABYLON.Vector3(dd["position"][0], dd["position"][1], dd["position"][2]),
						//size: new BABYLON.Vector3(dd["size"][0], dd["size"][1], dd["size"][2])
						size: decalSize
					}, 
					scene
			);
			decal.material = decalMaterial;
			
			// NOTE: Whether to use x or z to position horizontally and whether to 
			//       add or subtract might depend on the panel rotation.
			//decal.position.x += 1; // This moves it away.
			decal.position.y += dd.position[0]; // Move it up.
			decal.position.z += dd.position[1]; // Move it over.
		}
	
		// Add an event to the panel.
		SquidSpace.attachClickEventToObject("lonelypanelexample", "onClickShowPopup",
			{
				"title": "Greg Broadmore – Artist Guest of Honour",
			 	"text": "Greg Broadmore, aka 'The King of Fatboss', is the ConZealand Artist Guest of Honour.",
				"link-text": "Greg Broadmore",
				"link": "https://conzealand.nz/greg-broadmore-guest"
			}, scene
		);   	
		//*/

		/* I want to add this for debugVerbose mode, but it isn't working and I don't have time to figure it out.
		var showWorldAxis = function showWorldAxis(size, scene) {
		    var makeTextPlane = function(text, color, size) {
		        var dynamicTexture = new BABYLON.DynamicTexture("DynamicTexture", 50, scene, true);
		        dynamicTexture.hasAlpha = true;
		        dynamicTexture.drawText(text, 5, 40, "bold 36px Arial", color , "transparent", true);
		        var plane = BABYLON.Mesh.CreatePlane("TextPlane", size, scene, true);
		        plane.material = new BABYLON.StandardMaterial("TextPlaneMaterial", scene);
		        plane.material.backFaceCulling = false;
		        plane.material.specularColor = new BABYLON.Color3(0, 0, 0);
		        plane.material.diffuseTexture = dynamicTexture;
		    return plane;
		     };
		    var axisX = BABYLON.Mesh.CreateLines("axisX", [
		      BABYLON.Vector3.Zero(), new BABYLON.Vector3(size, 0, 0), new BABYLON.Vector3(size * 0.95, 0.05 * size, 0),
		      new BABYLON.Vector3(size, 0, 0), new BABYLON.Vector3(size * 0.95, -0.05 * size, 0)
		      ], scene);
		    axisX.color = new BABYLON.Color3(1, 0, 0);
		    var xChar = makeTextPlane("X", "red", size / 10);
		    xChar.position = new BABYLON.Vector3(0.9 * size, -0.05 * size, 0);
		    var axisY = BABYLON.Mesh.CreateLines("axisY", [
		        BABYLON.Vector3.Zero(), new BABYLON.Vector3(0, size, 0), new BABYLON.Vector3( -0.05 * size, size * 0.95, 0),
		        new BABYLON.Vector3(0, size, 0), new BABYLON.Vector3( 0.05 * size, size * 0.95, 0)
		        ], scene);
		    axisY.color = new BABYLON.Color3(0, 1, 0);
		    var yChar = makeTextPlane("Y", "green", size / 10);
		    yChar.position = new BABYLON.Vector3(0, 0.9 * size, -0.05 * size);
		    var axisZ = BABYLON.Mesh.CreateLines("axisZ", [
		        BABYLON.Vector3.Zero(), new BABYLON.Vector3(0, 0, size), new BABYLON.Vector3( 0 , -0.05 * size, size * 0.95),
		        new BABYLON.Vector3(0, 0, size), new BABYLON.Vector3( 0, 0.05 * size, size * 0.95)
		        ], scene);
		    axisZ.color = new BABYLON.Color3(0, 0, 1);
		    var zChar = makeTextPlane("Z", "blue", size / 10);
		    zChar.position = new BABYLON.Vector3(0, 0.05 * size, 0.9 * size);
		};
		*/
	}
	
	//
	// Data for placer hooks.
	//

	var bannerlayout = {
		"artshow":{
			"x":5,
			"y":11.7,
			"z":-1 * 8.3 * 2 - 2,
			"rotateY":0,
			"texture":"arena-banner-artshow.png"
		},
		"artshow2":{
			"x":20,
			"y":11.7,
			"z":-1 * 8.3 * 2 - 2,
			"rotateY":0,
			"texture":"arena-banner-artshow.png"
		},
		"autograph":{
			"x":32,
			"y":11.7,
			"z":-1 * 8.3 * 5 - 2,
			"rotateY":-1 * Math.PI/2,
			"texture":"arena-banner-autographing.png"
		},
		"dealers-chatham":{
			"x":10,
			"y":11.7,
			"z":-1 * 8.3 * 4 - 2,
			"rotateY":0,
			"texture":"arena-banner-dealers.png"
		},
		"dealers-stewart":{
			"x":10,
			"y":11.7,
			"z":-1 * 8.3 * 5 - 2,
			"rotateY":0,
			"texture":"arena-banner-dealers.png"
		},
		"dealers-north":{
			"x":26,
			"y":11.7,
			"z":-1 * 8.3 * 4 - 2,
			"rotateY":0,
			"texture":"arena-banner-dealers.png"
		},
		"dealers-south":{
			"x":24,
			"y":11.7,
			"z":-1 * 8.3 * 5 - 2,
			"rotateY":0,
			"texture":"arena-banner-dealers.png"
		},
		"exhibit":{
			"x":24,
			"y":11.7,
			"z":-1 * 8.3 * 3 - 2,
			"rotateY":0,
			"texture":"arena-banner-exhibit.png"
		},
		"siteslection":{
			"x":3,
			"y":11.7,
			"z":-1 * 8.3 * 3 - 2,
			"rotateY":Math.PI / 2,
			"texture":"arena-banner-siteseleciton.png"
		},
	};

	var signfulllayout = {
        "Chicago2022":{
           "pos": [22, 0, 34.5],
            "rotateY":-1 * Math.PI / 4,
            "texture":"sign-Chicago2022.jpg"
        },
        "DisCon_III":{
           "pos": [27, 0, 34.5],
            "rotateY":-1 * Math.PI / 4,
            "texture":"DisCon_III.jpg"
        },
		"Glasgow":{
           "pos": [33, 0, 34.5],
	        "rotateY":-1 * Math.PI / 4,
	        "texture":"sign-glasgow.png"
	    },
	};

    var signhalflayout = {
       "PropSimonTam":{
           "pos": [18.8, 0, 10],
           "rotateY":1 * Math.PI / 4,
           "texture":"sign-half-Prop_Simon_Tam.png"
       },
       "Orodurin":{
           "pos": [18.8, 0, 20],
           "rotateY":1 * Math.PI / 4,
           "texture":"sign-half-Orodruin.png"
       },
       "Kadath":{
           "pos": [18.8, 0, 30],
           "rotateY":1 * Math.PI / 4,
           "texture":"sign-half-Kadath.png"
       },
       "Genosha":{
           "pos": [19.7, 0, 40],
           "rotateY":1 * Math.PI / 4,
           "texture":"sign-half-Genosha.png"
       },
       "Gallifrey":{
           "pos": [19.7, 0, 50],
           "rotateY":1 * Math.PI / 4,
           "texture":"sign-half-Gallifrey.jpg"
       },
   };
	
	//
	// Placer hooks.
	//
	
	var attachPlacerHooks = function(scene){
		// TODO: Once these are stabilized, move them to a Javascript module and just set them here.

		SquidSpace.attachPrepareBuiltinsHook(function(scene){
			if (debugVerbose)
				console.log("Preparing builtins.");
		});

		SquidSpace.attachPlacerHook("beamplacer",
			function(areaName, areaOrigin, config, placerName, meshes, data, objName) {
			if (debugVerbose)
				console.log(`beamplacer called! ${areaName}, ${areaOrigin}, ${config}, ${placerName}, ${data}`);
			for (beammesh of meshes){
	            for (var i = 0; i < 8; i++ ) {
	                var bm = beammesh.createInstance("beam1-" + i);
	                bm.position.z = -1 * i * 8.3;
	                bm.checkCollisions = false;
	            }
	        }
	    });

		SquidSpace.attachPlacerHook("bannerplacer",
			function(areaName, areaOrigin, config, placerName, meshes, data, objName) {
			if (debugVerbose)
				console.log(`bannerplacer called! ${areaName}, ${areaOrigin}, ${config}, ${placerName}, ${data}`);

			for (key in bannerlayout) {
				let bannerinfo = bannerlayout[key];
				let mat = new BABYLON.StandardMaterial("mat", scene);
				let bannerTexture = new BABYLON.Texture("./textures/" + bannerinfo.texture, scene);
				bannerTexture.vScale = -1;
				// mat.diffuseColor = BABYLON.Color3(1, 1, 1);
				mat.diffuseTexture = bannerTexture;
				mat.emissiveTexture = bannerTexture;
				mat.alpha = 0.9;
				mat.backFaceCulling = false;
				// NOTE: Not using SquidSpace.cloneObject() here because we aren't adding
				//       events or actions to these objects.
				for (index = 0; index < meshes.length; index++) {
			        let bn = meshes[index].clone("banner-" + index);
					bn.material = mat;
	                bn.position.x = bannerinfo.x;
	                bn.position.y = bannerinfo.y;
	                bn.position.z = bannerinfo.z;
	                bn.rotation.y = bannerinfo.rotateY;
	                bn.checkCollisions = false;
					bn.isVisible = true;
				}
			}
		});

		SquidSpace.attachPlacerHook("curtainplacer",
			function(areaName, areaOrigin, config, placerName, meshes, data, objName) {
				if (debugVerbose)
					console.log(`curtainplacer called! ${areaName}, ${areaOrigin}, ${config}, ${placerName}, ${data}`);

			// NOTE: if you need to verify meshes exist before using them, the
			//  	 the following example is one way.
			//
			//  if (typeof meshes != "undefined") {
			//     . . . code here
			//  }


			for (curtainmesh of meshes) {
				curtainmesh.isVisible = false;

				for (i = 0; i < 7; i++ ) {
					let bm = curtainmesh.createInstance("curtain1-" + i);
					bm.position.x = 0;
					bm.position.y = 0;
					bm.position.z = -1 * i * 10;
					bm.checkCollisions = false;
				}

				for (i = 0; i < 7; i++ ) {
					let bm = curtainmesh.createInstance("curtain2-" + i);
					bm.rotation.y = Math.PI;
					bm.position.x = 38;
					bm.position.y = 0;
					bm.position.z = -1 * i * 10 - 10;
					bm.checkCollisions = false;
				}

				for (i = 0; i < 4; i++ ) {
					let bm = curtainmesh.createInstance("curtain3-" + i);
					bm.rotation.y = -1 * Math.PI / 2;
					bm.position.x = i * 10;
					bm.position.y = 0;
					bm.position.z = -64;
					bm.checkCollisions = false;
				}
			}
		});

		SquidSpace.attachPlacerHook("squidplacer",
			function(areaName, areaOrigin, config, placerName, meshes, data, objName) {
			if (debugVerbose)
				console.log(`squidplacer called! ${areaName}, ${areaOrigin}, ${config}, ${placerName}, ${data}`);
			for (squidmesh of meshes){
		        for (var i = 0; i < 1; i++ ) {
		            var bm = squidmesh.createInstance("squid1-" + i);
		            bm.position = SquidSpace.makePointVector(data.position[0], data.position[1], data.position[2]);
		            bm.checkCollisions = false;
		        }
		    }
		});
	
		SquidSpace.attachPlacerHook("signfullplacer",
	      	function(areaName, areaOrigin, config, placerName, meshes, data, objName) {
			if (debugVerbose)
				console.log(`signfullplacer called! ${areaName}, ${areaOrigin}, ${config}, ${placerName}, ${data}`);

			for (key in signfulllayout) {
				let signfullinfo = signfulllayout[key];
				let mat = new BABYLON.StandardMaterial("mat", scene);
				let signfullTexture = new BABYLON.Texture("./textures/" + signfullinfo.texture, scene);
				signfullTexture.vScale = -1;
				// mat.diffuseColor = BABYLON.Color3(1, 1, 1);
				mat.diffuseTexture = signfullTexture;
				mat.emissiveTexture = signfullTexture;
				mat.alpha = 0.9;
				mat.backFaceCulling = false;

				// Using SquidSpace.cloneObject() here because we *are* adding events to these objects.
				let cloneMeshes = SquidSpace.cloneObject(objName, key);

				for (index = 0; index < cloneMeshes.length; index++) {
					let bn = cloneMeshes[index];
					if(index == 1) bn.material = mat;
					bn.position = SquidSpace.makePointVector(
															signfullinfo.pos[0],
															signfullinfo.pos[1],
															signfullinfo.pos[2]);
					bn.rotation.y = signfullinfo.rotateY;
					bn.checkCollisions = true;
					bn.isVisible = true;
				}
			}
		});

		SquidSpace.attachPlacerHook("signhalfplacer",
	    	function(areaName, areaOrigin, config, placerName, meshes, data, objName) {
	        if (debugVerbose)
	            console.log(`signhalfplacer called! ${areaName}, ${areaOrigin}, ${config}, ${placerName}, ${data}`);

	        for (key in signhalflayout) {
	            let signhalfinfo = signhalflayout[key];
	            let mat = new BABYLON.StandardMaterial("mat", scene);
	            let signhalfTexture = new BABYLON.Texture("./textures/" + signhalfinfo.texture, scene);
	            signhalfTexture.vScale = -1;
	            // mat.diffuseColor = BABYLON.Color3(1, 1, 1);
	            mat.diffuseTexture = signhalfTexture;
	            mat.emissiveTexture = signhalfTexture;
	            mat.alpha = 0.9;
	            mat.backFaceCulling = false;

				// NOTE: Not using SquidSpace.cloneObject() here because we aren't adding
				//       events or actions to these objects.
	            for (index = 0; index < meshes.length; index++) {
	                let bn = meshes[index].clone("sign-" + index);
	                if(index == 1) bn.material = mat;
	                bn.position = SquidSpace.makePointVector(
															signhalfinfo.pos[0],
															signhalfinfo.pos[1],
															signhalfinfo.pos[2]);
	                bn.rotation.y = signhalfinfo.rotateY;
	                bn.checkCollisions = true;
	                bn.isVisible = true;
	            }
	        }
	    });
		SquidSpace.attachPlacerHook("lightplacer",
			function(areaName, areaOrigin, config, placerName, meshes, data, objName){
			if (debugVerbose)
				console.log(`lightplacer called! ${areaName}, ${areaOrigin}, ${config}, ${placerName}, ${data}`);

			let gl = new BABYLON.GlowLayer("glow", scene, {});
			gl.intensity = 1.0;

			let lightFrontFill = new BABYLON.PointLight("pointLight",
													SquidSpace.makePointVector(25, 20, 0), scene);
			lightFrontFill.diffuse = new BABYLON.Color3(1, 1, 1);
			lightFrontFill.specular = new BABYLON.Color3(0.5, 0.5, 0.5);
			lightFrontFill.range = 90;

			let lightTopFill = new BABYLON.PointLight("pointLight",
													SquidSpace.makePointVector(25, 20, 60), scene);
			lightTopFill.diffuse = new BABYLON.Color3(1, 1, 1);
			lightTopFill.specular = new BABYLON.Color3(0.5, 0.5, 0.5);
			lightTopFill.range = 90;
		});
	}

	//
	// Events
	//

	var attachEvents = function(scene){
	   // TODO: Once these are stabilized, move them to a Javascript module and just set them here.
	   // NOTE: Must come after buildWorld call, because the objects must be loaded before
	   //       you can attach events to them.

	   // Show Popup events.
	   SquidSpace.attachClickEventToObject("Chicago2022", "onClickShowPopup",
	   	{
	   		"title": "Chicago 2022!",
	   	 	"text": "Chicago is bidding for the 2022 Worldcon. The theme for the bid is “Take to the Stars”.",
	   		"link-text": "Chicago 2022 Bid",
	   		"link": "https://squid.fanac.com/fan-tables/discon3/"
	   	}, scene
	   );
	   SquidSpace.attachClickEventToObject("DisCon_III", "onClickShowPopup",
	   	{
	   		"title": "DisCon III!",
	   	 	"text": "DisCon III, the 79th World Science Fiction Convention in 2021! Nancy Kress – Author Guest of Honor.",
	   		"link-text": "DisCon III",
	   		"link": "https://squid.fanac.com/fan-tables/chicago2022/"
	   	}, scene
	   );
	   SquidSpace.attachClickEventToObject("Glasgow", "onClickShowPopup",
	   	{
	   		"title": "Glasgow 2024!",
	   	 	"text": "Glasgow in 2024 – A Worldcon for Our Futures. Join us! 8th-12th August 2024.",
	   		"link-text": "Glasgow 2024",
	   		"link": "https://squid.fanac.com/fan-tables/glasgow2024/"
	   	}, scene
	   );   	
	}

	//
	// START BASIC SQUID HALL CODE
	//
	// NOTE: Cut and paste this code into your HTML file for a virtual Squid Hall.
	//

	// Debug settings. If 'debugVerbose' is true then more information is logged
	// to the console. if 'debugLayer' is true then a set of scene debug panels are
	// added to the screen.
	// TODO: Come up with a way to turn these on and off at runtime.
	//var debugVerbose = false;
	var debugVerbose = true;
	var debugLayer = false;
	//var debugLayer = true;

	// Set up Babylon.js.
	var canvas = document.getElementById("renderCanvas"); // Get the canvas element
	var engine = new BABYLON.Engine(canvas, true); // Generate the BABYLON 3D engine
	var scene = new BABYLON.Scene(engine);

	// Here we do basic preparation.
	SquidSpace.prepareWorld(scene, debugVerbose, debugLayer);
	
	// All experiments for things after the world prep go here.
	experimentAfterWorldPrep(scene);

	// Set SquidSpace hooks for custom features.
	attachPlacerHooks(scene);

	// Add event handlers. (The events themselves are added after SquidSpace.buildWorld() is called.)
	SquidSpace.addEventHandler("onClickShowPopup", function(sourceObjectName, data){
		showMessagePopup(data);
	});

	// Here's where we do the magic.
	document.addEventListener("DOMContentLoaded", (event) =>{
		// Create and activate the world space.
		if (SquidSpace.buildWorld(world, [furniture], scene, debugVerbose)) {
			// Register a render loop to repeatedly render the world space.
			// NOTE: Use commented out render loop below if you don't want FPS label.
			let currFPS = 0;
			let newFPS = 0;
		    var fpsLabel = document.getElementById("fpsLabel");
			
			// All experiments for things after the world build go here.
			experimentAfterWorldBuild(scene);

			// Add SquidSpace events for custom features.
			attachEvents(scene);

			engine.runRenderLoop(function() {
				scene.render();

				// Update FPS on screen if it has changed.
				newFPS = engine.getFps().toFixed();
				if (currFPS != newFPS) {
					currFPS = newFPS;
				    fpsLabel.innerHTML = `&nbsp;${currFPS} fps&nbsp;`;
				}
			});

			// Alternate render loop without FPS label.
			//engine.runRenderLoop(function() {
			//	scene.render();
			//});

			// Watch for browser/canvas resize events
			window.addEventListener("resize", function() {
				engine.resize();
			});
		}
		else {
			console.log("Failed to load squid space.")

			showMessagePopup(
				{
					"title": "Squid Hall 3D Space Failed to Load",
				 	"text": "We apologize! Something happened while loading the 3D simulation space. It's possible your computer or web browser do not support WebGL or other features required to make it work. Please try again with a different browser or computer."
				}
			);
		}
	});

	//
	// END BASIC SQUID HALL CODE
	//

//]]>
</script>
	</body>
</html>
